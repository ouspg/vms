- name: Create partitions
  hosts: all
  become: true
  tasks:

    - name: gpt
      ansible.builtin.command: parted /dev/sda mklabel gpt

    - name: make primary "fat32"
      ansible.builtin.command: parted /dev/sda mkpart primary fat32 1MiB 1024MiB

    - name: "boot"
      ansible.builtin.command: parted /dev/sda set 1 boot on

    - name: "esp"
      ansible.builtin.command: parted /dev/sda set 1 esp on

    - name: part ext4
      ansible.builtin.command: parted /dev/sda mkpart primary ext4 1025MiB 57GiB

    - name: Format EFI partition as FAT32
      ansible.builtin.filesystem:
        fstype: vfat
        dev: /dev/sda1
        force: yes

    - name: Format root partition as EXT4
      ansible.builtin.filesystem:
        fstype: ext4
        dev: /dev/sda2
        force: yes

    - name: Ensure /mnt exists and mount root partition
      ansible.builtin.file:
        path: /mnt
        state: directory
        mode: '0755'

    - name: Mount root partition to /mnt
      ansible.builtin.mount:
        path: /mnt
        src: /dev/sda2
        fstype: ext4
        state: mounted

    - name: Ensure /mnt/boot exists
      ansible.builtin.file:
        path: /mnt/boot
        state: directory
        mode: '0755'

    - name: Mount EFI partition to /mnt/boot
      ansible.builtin.mount:
        path: /mnt/boot
        src: /dev/sda1
        fstype: vfat
        state: mounted
